<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <title>Epidemic</title>
    <style>
      body {
        display: grid;
        gap: 1em;
        grid-template-columns: 1fr 1fr;
        width: 100vw;
        height: 100vh;
        padding: 0;
        margin: 0;
      }

      #leftMenu {
        margin: 1em;
      }

      canvas {
        margin: 1em;
        background: black;
      }
    </style>
  </head>
  <body>
    <div id="leftMenu">
      <!-- Infection Chance Slider -->
      <div>
        <label for="infection-chance">Infection Chance: <span id="infection-chance-value">0.001</span>
        </label>
        <input type="range" id="infection-chance" min="0" max="0.01" step="0.0001" value="0.001">
      </div>
  
      <!-- Infection Radius Slider -->
      <div>
        <label for="infection-radius">Infection Radius: <span id="infection-radius-value">64</span></label>
        <input type="range" id="infection-radius" min="0" max="100" step="1" value="64">
      </div>

      <button onclick="loop()">Play</button>
    </div>

    <canvas id="screen" width="640" height="640"></canvas>
    
    <script>
      // Get a reference to the canvas element
      const canvas = document.getElementById("screen")
      const ctx = canvas.getContext("2d")
      
      // Sliders 
      const infectionChanceSlider = document.getElementById('infection-chance');
      const infectionChanceValue = document.getElementById('infection-chance-value');
      const infectionRadiusSlider = document.getElementById('infection-radius');
      const infectionRadiusValue = document.getElementById('infection-radius-value');  

      // Global data
      let infectionChance = 0.001
      let infectionRadius = 64

      // Person
      class Person {
      constructor(x, y, state = 0) {
          this.x = x
          this.y = y
          this.radius = 8
          this.direction = 0 // Angle in radians
          this.state = state // 0 is healthy, 1 is sick, 2 is recovered
        }

        infectNearby(persons) {
          // Only infected persons can infect others
          if (this.state !== 1) return;

          for (let person of persons) {
              // Check if the person is already infected or recovered
              if (person.state !== 0) continue;

              let dx = this.x - person.x;
              let dy = this.y - person.y;
              let distance = Math.sqrt(dx * dx + dy * dy);

              // Check if the person is within the infection radius
              if (distance <= infectionRadius) {
                  // Infect the person
                  if (Math.random() < infectionChance) {
                      person.state = 1; // Set the person's state to infected
                  }
              }
          }
        }

        draw(ctx) {
          if (this.state == 0) {
            ctx.fillStyle = "white"
          } else if (this.state == 1) {
            ctx.fillStyle = "red"          
          } else if (this.state == 2) {
            ctx.fillStyle = "gray"  
          }

          // Draw person
          ctx.beginPath()
          ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI)
          ctx.fill()

          // Draw infection radius
          if (this.state == 1) {
            ctx.fillStyle = "red"
            ctx.globalAlpha = 0.2
            
            ctx.beginPath()
            ctx.arc(this.x, this.y, infectionRadius, 0, 2 * Math.PI)
            ctx.fill()

            ctx.globalAlpha = 1.0;
          }
        }

        move(amount) {
          this.x += (Math.random() - 0.5) * 2 * amount
          this.y += (Math.random() - 0.5) * 2 * amount
          if (this.x > 640) this.x = 640;
          if (this.y > 640) this.y = 640;
          if (this.x < 0) this.x = 0;
          if (this.y < 0) this.y = 0;
        }
      }

      // Create 100 random persons
      let persons = []
      for (let i = 0; i < 100; i++) {
        let x = Math.random() * 640
        let y = Math.random() * 640
        let infected = Math.random() > 0.8
        persons.push(new Person(x, y, infected ? 1 : 0))
      }

      // Game loop
      function sliders() {
        // Update the simulation variables when the sliders change
        infectionChanceSlider.addEventListener('input', function() {
          infectionChance = parseFloat(this.value)
          infectionChanceValue.textContent = this.value
        });

        infectionRadiusSlider.addEventListener('input', function() {
          infectionRadius = parseFloat(this.value)
          infectionRadiusValue.textContent = this.value
        });

        requestAnimationFrame(sliders)
      }
      sliders()

      function loop() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw persons
        for (let person of persons) {
          person.move(3)
          person.draw(ctx)
          person.infectNearby(persons)
        }

        // Loop every tick
        requestAnimationFrame(loop);
      }

      // INFECTION
      // infection radius 
      // chance of infection when in radius
      // infection duration

      // SOCIAL DISTANCING
      // social distancing factor (how far apart)
      // % of population that obeys social distancing

      // QUARANTINE
      // quarantine after x days of infection
      // % of people don't sho    </script>
  </body>
</html>